<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento de Ru√≠do</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 10px;
            background: linear-gradient(135deg, #1b5e20, #2e7d32);
            color: white;
            text-align: center;
            transition: background 0.5s ease-in-out;
            height: 90vh;
        }
        .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        #nivelRuido {
            font-size: 28px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease-in-out;
        }
        #nivelRuido:hover {
            transform: scale(1.1);
        }
        #nivelRuido span {
            font-size: 32px;
            margin-left: 8px;
        }
        #mensagem {
            font-size: 40px;
            font-weight: bold;
            text-transform: uppercase;
            text-align: center;
            flex-grow: 1;
            animation: fadeIn 1s ease-in-out;
        }
        #mensagem span {
            color: red;
            font-size: 44px;
        }
        #graficoContainer {
            width: 80%;
            height: 400px;
            margin: 40px auto 20px auto;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        #dataHora {
            font-size: 14px;
            font-weight: bold;
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            display: inline-block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
    <script>
        function atualizarDataHora() {
            const agora = new Date();
            const opcoes = { timeZone: 'America/Sao_Paulo', hour12: false };
            const dataFormatada = agora.toLocaleDateString('pt-BR', opcoes);
            const horaFormatada = agora.toLocaleTimeString('pt-BR', opcoes);
            document.getElementById("dataHora").innerHTML = `üìÖ ${dataFormatada} | ‚è∞ ${horaFormatada}`;
        }

        async function atualizarDados() {
            try {
                const response = await fetch("https://api.thingspeak.com/channels/2840125/feeds.json?results=30");
                const data = await response.json();

                if (!data.feeds || data.feeds.length === 0) {
                    throw new Error("Sem dados");
                }

                const feeds = data.feeds;
                const valores = feeds.map(feed => parseFloat(feed.field1));
                const tempos = feeds.map(feed => new Date(feed.created_at).toLocaleTimeString());
                const dataHoraUltimoDado = new Date(feeds[feeds.length - 1].created_at);

                const agora = new Date();
                const diferencaMinutos = (agora - dataHoraUltimoDado) / 60000;

                if (isNaN(valores[valores.length - 1]) || diferencaMinutos > 5) {
                    throw new Error("Dados desatualizados");
                }

                document.getElementById("nivelRuido").innerHTML = `<i>üîä</i> <span>${valores[valores.length - 1]} dB</span>`;

                atualizarInterface(valores[valores.length - 1]);
                atualizarGrafico(tempos, valores);
            } catch (error) {
                console.error("Erro ao obter dados:", error);
                document.getElementById("nivelRuido").innerHTML = `<span style="color: yellow;">‚ö†Ô∏è Sem dados atualizados</span>`;
                document.body.style.background = "linear-gradient(135deg, #555, #777)";
                document.getElementById("mensagem").innerHTML = "Aguardando dados atualizados...";
            }
        }

        function atualizarInterface(dB) {
            let corFundo = "linear-gradient(135deg, #1b5e20, #2e7d32)";
            let mensagem = "Ambiente Silencioso";

            if (dB > 52 && dB < 70) {
                corFundo = "linear-gradient(135deg, #ffcc00, #ff8800)";
                mensagem = "Por favor, fazer <span>SIL√äNCIO!</span>";
            } else if (dB > 70) {
                corFundo = "linear-gradient(135deg, #ff0000, #cc0000)";
                mensagem = "Por favor, fazer <span>SIL√äNCIO!</span>";
            }

            document.body.style.background = corFundo;
            document.getElementById("mensagem").innerHTML = mensagem;
        }

        function atualizarGrafico(labels, valores) {
            if (window.myChart) {
                window.myChart.destroy();
            }

            const ctx = document.getElementById("graficoCanvas").getContext("2d");
            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: "N√≠vel de Ru√≠do (dB)",
                        data: valores,
                        borderColor: "#fff",
                        backgroundColor: "rgba(255, 255, 255, 0.2)",
                        borderWidth: 2,
                        fill: true,
                        pointBackgroundColor: "#fff"
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { color: "white" } },
                        y: { ticks: { color: "white" } }
                    },
                    plugins: {
                        legend: { labels: { color: "white" } }
                    }
                }
            });
        }

        setInterval(atualizarDados, 5000);
        setInterval(atualizarDataHora, 1000);
    </script>
</head>
<body onload="atualizarDados(); atualizarDataHora();">
    <div class="container">
        <h2 id="nivelRuido"><i>üîä</i> <span>Carregando...</span></h2>
        <h2 id="mensagem">Carregando...</h2>
    </div>

    <div id="graficoContainer">
        <canvas id="graficoCanvas"></canvas>
    </div>

    <div id="dataHora">Carregando...</div>
</body>
</html>
